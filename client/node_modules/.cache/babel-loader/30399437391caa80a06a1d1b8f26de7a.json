{"ast":null,"code":"export function nonMaxSuppression(boxes, scores, maxOutputSize, iouThreshold, scoreThreshold) {\n  var numBoxes = boxes.shape[0];\n  var outputSize = Math.min(maxOutputSize, numBoxes);\n  var candidates = scores.map(function (score, boxIndex) {\n    return {\n      score: score,\n      boxIndex: boxIndex\n    };\n  }).filter(function (c) {\n    return c.score > scoreThreshold;\n  }).sort(function (c1, c2) {\n    return c2.score - c1.score;\n  });\n\n  var suppressFunc = function suppressFunc(x) {\n    return x <= iouThreshold ? 1 : 0;\n  };\n\n  var selected = [];\n  candidates.forEach(function (c) {\n    if (selected.length >= outputSize) {\n      return;\n    }\n\n    var originalScore = c.score;\n\n    for (var j = selected.length - 1; j >= 0; --j) {\n      var iou = IOU(boxes, c.boxIndex, selected[j]);\n\n      if (iou === 0.0) {\n        continue;\n      }\n\n      c.score *= suppressFunc(iou);\n\n      if (c.score <= scoreThreshold) {\n        break;\n      }\n    }\n\n    if (originalScore === c.score) {\n      selected.push(c.boxIndex);\n    }\n  });\n  return selected;\n}\n\nfunction IOU(boxes, i, j) {\n  var boxesData = boxes.arraySync();\n  var yminI = Math.min(boxesData[i][0], boxesData[i][2]);\n  var xminI = Math.min(boxesData[i][1], boxesData[i][3]);\n  var ymaxI = Math.max(boxesData[i][0], boxesData[i][2]);\n  var xmaxI = Math.max(boxesData[i][1], boxesData[i][3]);\n  var yminJ = Math.min(boxesData[j][0], boxesData[j][2]);\n  var xminJ = Math.min(boxesData[j][1], boxesData[j][3]);\n  var ymaxJ = Math.max(boxesData[j][0], boxesData[j][2]);\n  var xmaxJ = Math.max(boxesData[j][1], boxesData[j][3]);\n  var areaI = (ymaxI - yminI) * (xmaxI - xminI);\n  var areaJ = (ymaxJ - yminJ) * (xmaxJ - xminJ);\n\n  if (areaI <= 0 || areaJ <= 0) {\n    return 0.0;\n  }\n\n  var intersectionYmin = Math.max(yminI, yminJ);\n  var intersectionXmin = Math.max(xminI, xminJ);\n  var intersectionYmax = Math.min(ymaxI, ymaxJ);\n  var intersectionXmax = Math.min(xmaxI, xmaxJ);\n  var intersectionArea = Math.max(intersectionYmax - intersectionYmin, 0.0) * Math.max(intersectionXmax - intersectionXmin, 0.0);\n  return intersectionArea / (areaI + areaJ - intersectionArea);\n}","map":{"version":3,"sources":["../../../src/ssdMobilenetv1/nonMaxSuppression.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["export function nonMaxSuppression(boxes, scores, maxOutputSize, iouThreshold, scoreThreshold) {\r\n    var numBoxes = boxes.shape[0];\r\n    var outputSize = Math.min(maxOutputSize, numBoxes);\r\n    var candidates = scores\r\n        .map(function (score, boxIndex) { return ({ score: score, boxIndex: boxIndex }); })\r\n        .filter(function (c) { return c.score > scoreThreshold; })\r\n        .sort(function (c1, c2) { return c2.score - c1.score; });\r\n    var suppressFunc = function (x) { return x <= iouThreshold ? 1 : 0; };\r\n    var selected = [];\r\n    candidates.forEach(function (c) {\r\n        if (selected.length >= outputSize) {\r\n            return;\r\n        }\r\n        var originalScore = c.score;\r\n        for (var j = selected.length - 1; j >= 0; --j) {\r\n            var iou = IOU(boxes, c.boxIndex, selected[j]);\r\n            if (iou === 0.0) {\r\n                continue;\r\n            }\r\n            c.score *= suppressFunc(iou);\r\n            if (c.score <= scoreThreshold) {\r\n                break;\r\n            }\r\n        }\r\n        if (originalScore === c.score) {\r\n            selected.push(c.boxIndex);\r\n        }\r\n    });\r\n    return selected;\r\n}\r\nfunction IOU(boxes, i, j) {\r\n    var boxesData = boxes.arraySync();\r\n    var yminI = Math.min(boxesData[i][0], boxesData[i][2]);\r\n    var xminI = Math.min(boxesData[i][1], boxesData[i][3]);\r\n    var ymaxI = Math.max(boxesData[i][0], boxesData[i][2]);\r\n    var xmaxI = Math.max(boxesData[i][1], boxesData[i][3]);\r\n    var yminJ = Math.min(boxesData[j][0], boxesData[j][2]);\r\n    var xminJ = Math.min(boxesData[j][1], boxesData[j][3]);\r\n    var ymaxJ = Math.max(boxesData[j][0], boxesData[j][2]);\r\n    var xmaxJ = Math.max(boxesData[j][1], boxesData[j][3]);\r\n    var areaI = (ymaxI - yminI) * (xmaxI - xminI);\r\n    var areaJ = (ymaxJ - yminJ) * (xmaxJ - xminJ);\r\n    if (areaI <= 0 || areaJ <= 0) {\r\n        return 0.0;\r\n    }\r\n    var intersectionYmin = Math.max(yminI, yminJ);\r\n    var intersectionXmin = Math.max(xminI, xminJ);\r\n    var intersectionYmax = Math.min(ymaxI, ymaxJ);\r\n    var intersectionXmax = Math.min(xmaxI, xmaxJ);\r\n    var intersectionArea = Math.max(intersectionYmax - intersectionYmin, 0.0) *\r\n        Math.max(intersectionXmax - intersectionXmin, 0.0);\r\n    return intersectionArea / (areaI + areaJ - intersectionArea);\r\n}\r\n//# sourceMappingURL=nonMaxSuppression.js.map"]},"metadata":{},"sourceType":"module"}